<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <meta name="robots" content="index, follow">
  <!-- title -->
  <% if (page.total > 1){ %>
    <% if (page.current === 1) { %>
  <title><%= config.title %> - <%= config.subtitle %></title>
    <% } else { %>
  <title>第<%= page.current %>页 - <%= config.title %></title>
    <% } %>
  <% } else { %>
    <% if (is_archive()) { %>
  <title>所有文章 - <%= config.title %></title>
    <% } else if (is_category()) { %>
  <title><%= page.category %> - <%= config.title %></title>
    <% } else if (is_tag()) { %>
  <title><%= page.tag %> - <%= config.title %></title>
    <% } else if (is_post()) { %>
  <title><%= page.title %> - <%= config.title %></title>
    <% } else if (page.path === 'index.html' || page.path === '') { %>
  <title><%= config.title %> - <%= config.subtitle %></title>
    <% } else { %>
  <title><%= page.title %> - <%= config.title %></title>
    <% } %>
  <% } %>
  
  <!-- open graph -->
  <%- open_graph() %>
  <!-- canonical -->
  <% if (page.path === 'index.html' || page.path === '') { %>
  <link rel="canonical" href="<%= config.url %>">
  <% } else if (page.path.endsWith('index.html')) { %>
  <link rel="canonical" href="<%= config.url + '/' + page.path.replace('index.html', '') %>">
  <% } else { %>
  <link rel="canonical" href="<%= config.url + (page.path.startsWith('/') ? '' : '/') + page.path %>">
  <% } %>
  <!-- Favicon -->
  <link rel="shortcut icon" href="/img/favicon.png">
  
  <!-- Google Fonts 预加载 - 优化字体加载 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- 预加载所有字体 -->
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;1,400&family=Noto+Serif:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Noto+Serif+SC:wght@400;700;900&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;1,400&family=Noto+Serif:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Noto+Serif+SC:wght@400;700;900&display=swap">
  
  <!-- 字体加载优化脚本 -->
  <script>
    // 字体加载优化
    (function() {
      // 检查是否支持Font Loading API
      if ('fonts' in document) {
        // 异步加载字体，不阻塞页面渲染
        setTimeout(function() {
          Promise.all([
            document.fonts.load('400 1em "JetBrains Mono"'),
            document.fonts.load('400 1em "Noto Serif"'),
            document.fonts.load('400 1em "Noto Serif SC"')
          ]).then(function() {
            document.documentElement.classList.add('fonts-loaded');
          }).catch(function() {
            document.documentElement.classList.add('fonts-fallback');
          });
        }, 0);
      } else {
        // 不支持Font Loading API的浏览器，直接使用系统字体
        document.documentElement.classList.add('fonts-fallback');
      }
    })();
  </script>
  
  <!-- CSS -->
  <%- css('css/reset.css') %>
  <%- css('css/style.css') %>
  <%- css('css/markdown.css') %>
  <%- css('css/fonts.css') %>
  <%- css('css/a11y-dark.min.css') %>
  
  <!-- 图片懒加载 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 预加载队列
      const preloadQueue = [];
      let isProcessing = false;
      let processedImages = new Set();
      
      // 创建loading效果
      function createLoadingEffect(img) {
        // 检查是否已经有容器
        let container = img.parentElement;
        if (!container || !container.classList.contains('image-container')) {
          // 创建图片容器
          container = document.createElement('div');
          container.className = 'image-container loading';
          
          // 将图片包装在容器中
          img.parentNode.insertBefore(container, img);
          container.appendChild(img);
        } else {
          // 如果已有容器，添加loading类
          container.classList.add('loading');
        }
        
        return container;
      }
      
      // 移除loading效果
      function removeLoadingEffect(container) {
        if (container && container.classList.contains('loading')) {
          container.classList.remove('loading');
        }
      }
      
      // 处理预加载队列
      function processPreloadQueue() {
        if (isProcessing || preloadQueue.length === 0) return;
        
        isProcessing = true;
        const img = preloadQueue.shift();
        
        if (img && img.dataset.src && !processedImages.has(img)) {
          processedImages.add(img);
          
          // 添加loading效果
          const container = createLoadingEffect(img);
          
          img.src = img.dataset.src;
          
          img.addEventListener('load', function() {
            img.classList.add('loaded');
            removeLoadingEffect(container);
            isProcessing = false;
            // 继续处理队列中的下一张图片
            setTimeout(processPreloadQueue, 10);
          });
          
          img.addEventListener('error', function() {
            removeLoadingEffect(container);
            isProcessing = false;
            // 继续处理队列中的下一张图片
            setTimeout(processPreloadQueue, 10);
          });
        } else {
          isProcessing = false;
          // 继续处理队列中的下一张图片
          setTimeout(processPreloadQueue, 10);
        }
      }
      
      // 处理所有图片
      function handleImages() {
        // 选择所有懒加载图片，但排除favicon
        const lazyImages = document.querySelectorAll('.lazy-image');
        const allImages = document.querySelectorAll('img');
        

        
        // 如果没有懒加载图片，检查是否有需要处理的图片
        if (lazyImages.length === 0) {
          allImages.forEach(img => {
            // 排除favicon.png
            if (img.src && !img.src.includes('favicon.png') && !img.src.includes('github.png') && !img.src.includes('mail.png') && !img.src.includes('rss-fill.png') && !img.src.includes('Telegram.png') &&
                img.dataset.src && !img.classList.contains('lazy-image')) {
              // 如果有data-src属性，说明是懒加载图片
              img.classList.add('lazy-image');
              
              // 添加loading效果
              const container = createLoadingEffect(img);
              
              // 立即加载图片
              img.src = img.dataset.src;
              
              // 图片加载完成后的处理
              img.addEventListener('load', function() {
                img.classList.add('loaded');
                removeLoadingEffect(container);
              });
              
              img.addEventListener('error', function() {
                removeLoadingEffect(container);
              });
            }
          });
          return;
        }
        
        // 使用Intersection Observer处理懒加载图片
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              
              // 检查是否有data-src属性
              if (img.dataset.src && !processedImages.has(img)) {
                // 将图片添加到预加载队列
                preloadQueue.push(img);
                processPreloadQueue();
              } else if (!img.dataset.src) {
                // 如果没有data-src，直接显示图片
                img.classList.add('loaded');
              }
              
              // 停止观察这个图片
              observer.unobserve(img);
            }
          });
        }, {
          rootMargin: '400px 0px', // 提前400px开始加载，大幅提升加载速度
          threshold: 0.001 // 降低阈值，图片刚进入视口就开始加载
        });
        
        // 开始观察所有懒加载图片
        lazyImages.forEach(img => {
          // 排除favicon.png
          if (!img.src.includes('favicon.png') && !img.src.includes('github.png') && !img.src.includes('mail.png') && !img.src.includes('rss-fill.png') && !img.src.includes('Telegram.png')) {
            imageObserver.observe(img);
          }
        });
      }
      
      // 立即执行一次
      handleImages();
      
      // 减少延迟时间，提升响应速度
      setTimeout(handleImages, 20);
    });
  </script>
</head>
